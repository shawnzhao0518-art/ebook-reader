<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>沉浸式翻译网站</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f9f9f9; }
    h2 { color: #007aff; }
    textarea { width: 100%; height: 150px; margin-top: 10px; }
    input[type=file] { margin: 15px 0; }
    button { margin-top: 10px; padding: 10px 20px; background: #007aff; color: white; border: none; cursor: pointer; }
    .block { margin-bottom: 20px; padding: 12px; background: #fff; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .orig { font-weight: bold; margin-bottom: 5px; }
    .trans { color: #007700; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>🌏 沉浸式翻译工具</h2>
  <p>输入文本或上传文件（TXT / PDF / Word / EPUB）：</p>
  <textarea id="inputText" placeholder="在这里粘贴文本..."></textarea>
  <br>
  <input type="file" id="fileInput" accept=".txt,.pdf,.docx,.epub">
  <br>
  <button onclick="startTranslation()">开始翻译</button>

  <div id="output"></div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <!-- Mammoth.js for Word -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <!-- epub.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.88/epub.min.js"></script>

  <script>
    // 🔹 调用免费翻译 API (LibreTranslate)
    async function translateParagraph(paragraph) {
      let res = await fetch("https://libretranslate.com/translate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          q: paragraph,
          source: "en",
          target: "zh",
          format: "text"
        })
      });
      let data = await res.json();
      return data.translatedText || "(翻译失败)";
    }

    // 🔹 执行翻译
    async function startTranslation() {
      let text = document.getElementById("inputText").value;
      let file = document.getElementById("fileInput").files[0];

      if (file) {
        let ext = file.name.split('.').pop().toLowerCase();
        if (ext === "txt") text = await readTxt(file);
        if (ext === "pdf") text = await readPdf(file);
        if (ext === "docx") text = await readDocx(file);
        if (ext === "epub") text = await readEpub(file);
      }

      if (!text) {
        alert("请输入文本或上传文件");
        return;
      }

      let paragraphs = text.split(/\n+/);
      let outputDiv = document.getElementById("output");
      outputDiv.innerHTML = "";

      for (let p of paragraphs) {
        if (!p.trim()) continue;
        let block = document.createElement("div");
        block.className = "block";
        block.innerHTML = `<div class="orig">${p}</div><div class="trans">翻译中...</div>`;
        outputDiv.appendChild(block);

        let translation = await translateParagraph(p);
        block.querySelector(".trans").innerText = translation;
      }
    }

    // 🔹 读取 TXT
    function readTxt(file) {
      return new Promise((resolve) => {
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsText(file);
      });
    }

    // 🔹 读取 PDF
    async function readPdf(file) {
      let arrayBuffer = await file.arrayBuffer();
      let pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        let page = await pdf.getPage(i);
        let content = await page.getTextContent();
        let strings = content.items.map(item => item.str).join(" ");
        text += strings + "\n\n";
      }
      return text;
    }

    // 🔹 读取 Word
    async function readDocx(file) {
      let arrayBuffer = await file.arrayBuffer();
      let result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
      return result.value;
    }

    // 🔹 读取 EPUB
    async function readEpub(file) {
      return new Promise((resolve) => {
        let book = ePub(file);
        let text = "";
        book.loaded.spine.then(spine => {
          let promises = spine.each(chapter => chapter.load().then(res => {
            text += res.innerText + "\n\n";
          }));
          Promise.all(promises).then(() => resolve(text));
        });
      });
    }
  </script>
</body>
</html>
